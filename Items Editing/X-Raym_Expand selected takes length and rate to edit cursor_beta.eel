/**
 * ReaScript Name: Randomize take playback rate
 * Description: This script is a demonstration of how we can randomize take playback rate. It is not meant to be use without modifications of the R value.
 * Instructions: Here is how to use it. (optional)
 * Author: X-Raym
 * Author URl: http://extremraym.com
 * Repository: GitHub > X-Raym > EEL Scripts for Cockos REAPER
 * Repository URl: https://github.com/X-Raym/REAPER-EEL-Scripts
 * File URl: https://github.com/X-Raym/REAPER-EEL-Scripts/scriptName.eel
 * Licence: GPL v3
 * Forum Thread: Scripts (EEL): Randomize Take Playback Rate
 * Forum Thread URl: http://forum.cockos.com/showthread.php?p=1520462
 * REAPER: 4.76
 * Extensions: None
 */
 
/**
 * Changelog:
 * v1.1 (2015-05-12)
  + Randomize from snap offset position
  + Support for fades
 * v1.0 ()
  + Initial Release
 */
 // ----- DEBUGGING ====>
@import ../Functions/X-Raym_Functions - console debug messages.eel

debug = 1; // 0 => No console. 1 => Display console messages for debugging.
clean = 1; // 0 => No console cleaning before every script execution. 1 => Console cleaning before every script execution.

msg_clean();
msg_start();
// <==== DEBUGGING ----

function rand_take_pb_rate() local(i, mouse_item, take)
(
	// GET MOUSE ITEM AND MOUSE TAKE
    mouse_item = extension_api("BR_ItemAtMouseCursor", mouse_pos);
      (mouse_take = GetActiveTake(mouse_item)) ? (
		
		// GET CURSOR POS
        cursor_pos = GetCursorPositionEx(0);

        // INITIAL ITEM INFOS
        init_fadein = GetMediaItemInfo_Value(mouse_item, "D_FADEINLEN");
        init_fadeout = GetMediaItemInfo_Value(mouse_item, "D_FADEOUTLEN");
        init_rate = GetMediaItemTakeInfo_Value(mouse_take, "D_PLAYRATE");
        init_position = GetMediaItemInfo_Value(mouse_item, "D_POSITION");
        init_length = GetMediaItemInfo_Value(mouse_item, "D_LENGTH");
        init_snap = GetMediaItemInfo_Value(mouse_item, "D_SNAPOFFSET");
        init_end = init_position + init_length;
		init_snap_absolute = init_snap + init_position;
		
		// IF CURSOR ISN'T ON MOUSE ITEM SNAP OFFSET
		cursor_pos < init_snap_absolute || cursor_pos > init_snap_absolute ? (
       
			// USE SOURCE AS REFRENCE
			src_pos = init_position * init_rate;
			src_snap = init_snap * init_rate;
			src_fadein = init_fadein * init_rate;
			src_fadeout = init_fadeout * init_rate;
			src_length = init_length * init_rate;
			src_end = init_end * init_rate;

			// SET NEW LENGTH

			// IF EDIT CURSOR IS BEFORE SNAP
			cursor_pos < init_snap_absolute ? (
			
				// IF SNAP ISN'T 0
				src_snap != 0 ?(
					new_length = (init_position - cursor_pos) * (src_length/src_snap) + init_length;
				):(
					// ELSEIF SNAP IS ZERO
					new_length = (init_position - cursor_pos) + init_length;

				); // END OF SNAP
				
				process = 1;
			);
			
			// IF EDIT CURSOR IS AFTER SNAP
			cursor_pos > init_snap_absolute ? (
				
				// IF SNAP ISN'T 0
				src_snap != 0 ?(
					// HERE IT IS - NEED TO BE FIXED, RELATIVE TO SNAOSITON
					new_length = (cursor_pos - init_position);
				):(
					// ELSEIF SNAP IS 0
					new_length = (cursor_pos - init_position);
				); // END IF SNAP
				
				process = 1;
			
			);

			// NEW RATE
			R = src_length/new_length;

			// SET VALUES
			SetMediaItemTakeInfo_Value(mouse_take, "D_PLAYRATE", R);

			new_snap = src_snap / R;
			SetMediaItemInfo_Value(mouse_item, "D_SNAPOFFSET", new_snap);
			
			src_snap != 0 ?(
				snap_dif = init_snap - new_snap;
				SetMediaItemInfo_Value(mouse_item, "D_POSITION", init_position + snap_dif);
			):(
				cursor_pos > init_snap_absolute ? (
					SetMediaItemInfo_Value(mouse_item, "D_POSITION", init_position + snap_dif);
				);
				cursor_pos < init_snap_absolute ? (
					SetMediaItemInfo_Value(mouse_item, "D_POSITION", cursor_pos);
				);
			);
			
			SetMediaItemInfo_Value(mouse_item, "D_LENGTH", new_length);
			
			init_fadein > 0 ? (
			  SetMediaItemInfo_Value(mouse_item, "D_FADEINLEN", src_fadein / R);
			);

			init_fadein > 0 ? (
			  SetMediaItemInfo_Value(mouse_item, "D_FADEOUTLEN", src_fadeout / R);
			);
			
			// PROPAGATE TRANSFORMATION
			//(set IF not ITEM under mouse, adjust item, based transform on snap...)
			/*i = 0;
			rate_ratio = init_rate/R;
			loop(CountSelectedMediaItems(0),
				
				item = GetSelectedMediaItem(0,i);
				(take = GetActiveTake(item)) ? (
					rate = GetMediaItemTakeInfo_Value(take, "D_PLAYRATE");
					dest_rate = rate / rate_ratio;
					SetMediaItemTakeInfo_Value(take, "D_PLAYRATE", dest_rate);
				); // HAVE TAKE
				
				i += 1;
			
			);*/
		
		); // IF CURSOR ISN'T ON SNAP ABSOLUTE'
	
	);// IS TAKE

  UpdateArrange(); // refresh arrange view
  Undo_OnStateChange("Randomize take playback rate");

);

PreventUIRefresh(1);
rand_take_pb_rate();
PreventUIRefresh(-1);
